name: test-devcontainer

# Test devcontainer features

on:
  push:
    tags: ["v*"]
    branches: ["main", "mise"]
    paths:
      - packaging/devcontianer/**
  pull_request:
    branches: ["main"]
    paths:
      - packaging/devcontianer/**
  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

env:
  MISE_TRUSTED_CONFIG_PATHS: ${{ github.workspace }}

jobs:
  # Test default installation on several base images
  test-autogenerated:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        baseImage:
          - debian:latest
          - ubuntu:latest
          - mcr.microsoft.com/devcontainers/base:ubuntu
          - mcr.microsoft.com/devcontainers/base:debian
    steps:
      - uses: actions/checkout@v4

      - name: "Install latest devcontainer CLI"
        run: npm install -g @devcontainers/cli

      - name: "Generating tests against '${{ matrix.baseImage }}'"
        run: devcontainer features test --skip-scenarios -f mise -i ${{ matrix.baseImage }} packaging/devcontainer

  # Test feature scenarios on base:ubuntu image
  test-scenarios:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: "Install latest devcontainer CLI"
        run: npm install -g @devcontainers/cli

      - name: "Generating tests for scenarios"
        run: devcontainer features test --skip-autogenerated --skip-duplicated packaging/devcontainer
